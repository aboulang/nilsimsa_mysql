CREATE
    FUNCTION nilsimsa_compare(hash1 VARCHAR(64), hash2 VARCHAR(64)) RETURNS INT 
    DETERMINISTIC NO SQL
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE bit_diff_sum INT DEFAULT 0;
    DECLARE byte1 INT;
    DECLARE byte2 INT;
    DECLARE POPC BLOB;

    SET popc = UNHEX(
            CONCAT('0001010201020203010202030203030401020203020303040203030403040405010202030203030402030304030404050',
                   '2030304030404050304040504050506010202030203030402030304030404050203030403040405030404050405050602',
                   '0303040304040503040405040505060304040504050506040505060506060701020203020303040203030403040405020',
                   '3030403040405030404050405050602030304030404050304040504050506030404050405050604050506050606070203',
                   '0304030404050304040504050506030404050405050604050506050606070304040504050506040505060506060704050',
                   '506050606070506060706070708'));
    IF LENGTH(hash1) != 64 OR LENGTH(hash2) != 64 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Invalid Nilsimsa hashes';
    END IF;

    REPEAT
        SET byte1 = CONV(SUBSTRING(hash1, i * 2 + 1, 2), 16, 10);
        SET byte2 = CONV(SUBSTRING(hash2, i * 2 + 1, 2), 16, 10);
        SET bit_diff_sum = bit_diff_sum + ORD(SUBSTRING(POPC, byte1 ^ byte2 + 1, 1));
        SET i = i + 1;
    UNTIL i = 32
    END REPEAT;

    RETURN 128 - bit_diff_sum;
END;
